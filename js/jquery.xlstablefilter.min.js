(function(e){e.widget("jk.xlsTableFilter",{options:{width:400,height:550,maxHeight:e(window).height(),ignoreCase:true,checkStyle:"default",ignoreColumns:[],onlyColumns:null,rowsDisplay:"xlsTableFilterRowsDisplay"},filters:{},elid:null,_create:function(){var t=this,n=t.element,r=e(n).find("th");t.elid=n.prop("id");t.filters[t.elid]={};e.each(r,function(n,r){var i=t.options.onlyColumns==null&&jQuery.inArray(n,t.options.ignoreColumns)==-1||jQuery.inArray(n,t.options.onlyColumns)!==-1?true:false;if(i==true){e(this).addClass("xlsFilterHeader").on("click.xlsTableFilter",function(n){t._openFilter(e(this))})}else{e(this).addClass("xlsNoFilterHeader")}});t._printRowsDisplayed()},_openFilter:function(t){var n=this;var r=t.index()+1;var i=n._getFilterContent(t);var s=n._createDialogDiv("divXlsFilter","Filter - "+t.text(),i);n._setupFilter();e(s).dialog({resizable:false,autoOpen:true,width:n.options.width,height:n.options.height,maxHeight:n.options.maxHeight,modal:true,show:400,hide:400,buttons:{Filter:function(){n._filterTable(r);e(this).dialog("close")},Cancel:function(){e(this).dialog("close");return false}},close:function(){e(this).dialog("destroy");e(this).remove()}})},_getFilterContent:function(t){var n=this;var r=t.index()+1;var i=new Array;e.each(e(n.element).find("tr td:nth-of-type("+r+")"),function(t,n){i[i.length]=e(n).text()});i=n.sortUnique(i);var s='<form id="xlsFilterForm">';s=s+'<div>Text Search <input type="text" id="filterSearch" style="width: 200px;"></div>';s=s+'<div id="xlsFilterAllNone"><span id="xlsFilterAll">All</span> | <span id="xlsFilterNone">None</span></div>';s=s+'<div id="xlsFilterRows">';e.each(i,function(e,t){s=s+n._addFilterRow(t,r)});s=s+"</div></form>";return s},_setupFilter:function(){var t=this;e("#xlsFilterAll").click(function(){e.each(e("div.xlsFilterRow"),function(){t.checkRow(e(this),true)})});e("#xlsFilterNone").click(function(){e.each(e("div.xlsFilterRow"),function(){t.checkRow(e(this),false)})});e("div.xlsFilterRow input").on("click",function(e){e.stopPropagation()});e("div.xlsFilterRow").click(function(){t.checkRow(e(this))});e("#filterSearch").blur(t._filterBySearchField);e("#filterSearch").focus(t._filterBySearchField);e("#filterSearch").keyup(t._filterBySearchField)},_addFilterRow:function(e,t){var n=this;var r=e.length==0?"<i><blank></i>":e;e=n._adjustCase(e);if(n.filters[n.elid]["col"+t]){var i=jQuery.inArray(e,n.filters[n.elid]["col"+t])==-1?false:true}else{var i=true}var s='<div class="xlsFilterRow"><input type="checkbox" style="'+(n.options.checkStyle=="default"?"":"display: none;")+'" value="'+e+'" '+(i==true?"checked ":"")+'name="selFilter[]">'+(n.options.checkStyle=="default"?"":'<div class="xlsFilterCheck xlsFilterCheckO'+(i==true?"n":"ff")+'"></div>')+"<span>"+r+"</span></div>";return s},checkRow:function(t,n){var r=this;var i=e(t).find("input");n=arguments.length==2?n:i.prop("checked")==true?false:true;i.prop("checked",n);if(r.options.checkStyle=="custom"){var s=t.find(".xlsFilterCheck");s.addClass(n==true?"xlsFilterCheckOn":"xlsFilterCheckOff");s.removeClass(n==true?"xlsFilterCheckOff":"xlsFilterCheckOn")}},_filterBySearchField:function(){var t=this;if(e("#filterSearch").val().length==0){e("div.xlsFilterRow").show()}else{e.each(e("div.xlsFilterRow input"),function(){if(e(this).val().toLowerCase().indexOf(e("#filterSearch").val().toLowerCase())===-1){e(this).parent().hide()}else{e(this).parent().show()}})}},_createDialogDiv:function(t,n,r){var i=this;if(e("#"+t).length>0){e("#"+t).html(r).attr("title",n)}else{e("body").append('<div id="'+t+'" title="'+n+'" style="display: none;">'+r+"</div>")}return e("#"+t)},_filterTable:function(t){var n=this;var r="col"+t;n.filters[n.elid][r]=new Array;e.each(e("div.xlsFilterRow input:checked"),function(){n.filters[n.elid][r][n.filters[n.elid][r].length]=e(this).val()});if(e("div.xlsFilterRow input").not(":checked").length===0){n.element.find("thead th:nth-of-type("+t+")").removeClass("xlsFilteredColumn")}else{n.element.find("thead th:nth-of-type("+t+")").addClass("xlsFilteredColumn")}e.each(n.element.find("tbody tr"),function(){var t=e(this);var r=true;t.show();e.each(n.filters[n.elid],function(e,i){var s=e.substr(3);if(r==true){if(jQuery.inArray(n._adjustCase(t.children("td:nth-of-type("+s+")").text()),i)==-1){t.hide();return false}}})});n._printRowsDisplayed()},_printRowsDisplayed:function(){var t=this;if(t.options.rowsDisplay!==false){var n=t.element.find("tbody tr:visible").length;var r=t.element.find("tbody tr").length;var i=typeof t.options.rowsDisplay=="object"?t.options.rowsDisplay:e("#"+t.options.rowsDisplay);i.html("Displaying "+n+(n!=r?" of "+r+" row"+(r==1?"":"s"):" row"+(n==1?"":"s"))+".")}},_adjustCase:function(e){var t=this;return t.options.ignoreCase==true?e.toLowerCase():e},sortUnique:function(e){var t=this;e.sort(function(e,n){e=t._adjustCase(e);n=t._adjustCase(n);if(e==n)return 0;return e>n?1:-1});var n=[e[0]];for(var r=1;r<e.length;r++){if(t._adjustCase(e[r-1])!==t._adjustCase(e[r])){n.push(e[r])}}return n},_setOption:function(e,t){options.key=t},destroy:function(){var t=this,n=this.element.find("th");e.each(n,function(n,r){var i=t.options.onlyColumns==null&&jQuery.inArray(n,t.options.ignoreColumns)==-1||jQuery.inArray(n,t.options.onlyColumns)!==-1?true:false;if(i==true){e(this).removeClass("xlsFilterHeader").off("click.xlsTableFilter")}else{e(this).removeClass("xlsNoFilterHeader")}})}})})(jQuery)